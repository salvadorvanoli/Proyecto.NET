services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: proyectonet-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SQL_SERVER_PASSWORD}
      - MSSQL_PID=${MSSQL_PID:-Developer}
    ports:
      - "${SQL_PORT:-1433}:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - proyectonet-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"${SQL_SERVER_PASSWORD}\" -Q 'SELECT 1' -C || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  web-api:
    build:
      context: .
      dockerfile: Dockerfile
      target: final-api
      args:
        BUILD_CONFIGURATION: ${BUILD_CONFIGURATION:-Release}
    container_name: proyectonet-api
    ports:
      - "${API_HTTP_PORT:-5000}:8080"
      - "${API_HTTPS_PORT:-5443}:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=${DB_NAME:-ProyectoNetDb};User Id=sa;Password=${SQL_SERVER_PASSWORD};TrustServerCertificate=True;MultipleActiveResultSets=true
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD:-P@ssw0rd123!},abortConnect=false
      - Logging__Console__FormatterName=simple
      - SEED_DATABASE=${SEED_DATABASE:-false}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-}
      - Jwt__Secret=${JWT_SECRET}
      - Jwt__Issuer=${JWT_ISSUER:-ProyectoNet}
      - Jwt__Audience=${JWT_AUDIENCE:-ProyectoNetClients}
      - Jwt__LifetimeMinutes=${JWT_LIFETIME_MINUTES:-60}
      - Redis__Enabled=${REDIS_ENABLED:-true}
      - Redis__DefaultTtlMinutes=${REDIS_DEFAULT_TTL_MINUTES:-30}
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - proyectonet-network
    restart: unless-stopped
    labels:
      - "com.proyecto.net.service=api"
      - "com.proyecto.net.description=API REST Backend"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  web-backoffice:
    build:
      context: .
      dockerfile: Dockerfile
      target: final-backoffice
      args:
        BUILD_CONFIGURATION: ${BUILD_CONFIGURATION:-Release}
    container_name: proyectonet-backoffice
    ports:
      - "${BACKOFFICE_HTTP_PORT:-5001}:8080"
      - "${BACKOFFICE_HTTPS_PORT:-5444}:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=${DB_NAME:-ProyectoNetDb};User Id=sa;Password=${SQL_SERVER_PASSWORD};TrustServerCertificate=True;MultipleActiveResultSets=true
      - API_BASE_URL=${API_BASE_URL:-http://web-api:8080}
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD:-P@ssw0rd123!},abortConnect=false
      - Redis__Enabled=${REDIS_ENABLED:-true}
      - Redis__DefaultTtlMinutes=${REDIS_DEFAULT_TTL_MINUTES:-30}
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      web-api:
        condition: service_started
    networks:
      - proyectonet-network
    restart: unless-stopped
    labels:
      - "com.proyecto.net.service=backoffice"
      - "com.proyecto.net.description=Panel de Administración"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  web-frontoffice:
    build:
      context: .
      dockerfile: Dockerfile
      target: final-frontoffice
      args:
        BUILD_CONFIGURATION: ${BUILD_CONFIGURATION:-Release}
    container_name: proyectonet-frontoffice
    ports:
      - "${FRONTOFFICE_HTTP_PORT:-5002}:8080"
      - "${FRONTOFFICE_HTTPS_PORT:-5445}:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:8080
      - API_BASE_URL=${API_BASE_URL:-http://web-api:8080}
      - ConnectionStrings__Redis=redis:6379,password=${REDIS_PASSWORD:-P@ssw0rd123!},abortConnect=false
      - Redis__Enabled=${REDIS_ENABLED:-true}
      - Redis__DefaultTtlMinutes=${REDIS_DEFAULT_TTL_MINUTES:-15}
    depends_on:
      redis:
        condition: service_healthy
      web-api:
        condition: service_started
    networks:
      - proyectonet-network
    restart: unless-stopped
    labels:
      - "com.proyecto.net.service=frontoffice"
      - "com.proyecto.net.description=Aplicación de Usuarios"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  redis:
    image: redis:7.2-alpine
    container_name: proyectonet-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-P@ssw0rd123!}
    volumes:
      - redis-data:/data
    networks:
      - proyectonet-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  seq:
    image: datalust/seq:latest
    container_name: proyectonet-seq
    ports:
      - "5341:80"
    environment:
      - ACCEPT_EULA=Y
    volumes:
      - seq-data:/data
    networks:
      - proyectonet-network
    restart: unless-stopped
    profiles:
      - monitoring
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

networks:
  proyectonet-network:
    driver: bridge
    name: proyectonet-network

volumes:
  sqlserver-data:
    name: proyectonet-sqlserver-data
  redis-data:
    name: proyectonet-redis-data
  seq-data:
    name: proyectonet-seq-data
