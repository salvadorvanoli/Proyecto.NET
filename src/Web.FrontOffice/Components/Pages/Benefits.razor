@page "/mis-beneficios"
@using Web.FrontOffice.Components.Shared
@using Web.FrontOffice.Services.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities
@inject IBenefitApiService BenefitApiService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ILogger<Benefits> Logger
@rendermode InteractiveServer

<Microsoft.AspNetCore.Components.Web.PageTitle>Mis Beneficios</Microsoft.AspNetCore.Components.Web.PageTitle>

<div class="benefits-container">
    <PageHeader Title="Mis Beneficios" Subtitle="Beneficios disponibles y consumidos" />

    @if (isLoading)
    {
        <div class="loading">
            <p>Cargando beneficios...</p>
        </div>
    }
    else if (error != null)
    {
        <div class="alert alert-danger">
            <p>@error</p>
            <hr />
            <p><strong> Para testing:</strong> Accede a <code>/mis-beneficios?devUserId=1</code> para cargar los beneficios del usuario con ID 1.</p>
        </div>
    }
    else if (!benefits.Any())
    {
        <div class="no-data">
            <p>No hay beneficios disponibles en este momento.</p>
        </div>
    }
    else
    {
        <div class="benefits-grid">
            @foreach (var benefit in benefits)
            {
                <Card Title="@benefit.BenefitType.Name">
                    <div class="benefit-content">
                        <p class="benefit-description">@benefit.BenefitType.Description</p>

                        <div class="benefit-details">
                            @if (benefit.ValidityPeriod != null)
                            {
                                <InfoField Label="Vigencia Desde" Value="@benefit.ValidityPeriod.StartDate.ToString("dd/MM/yyyy")" />
                                <InfoField Label="Vigencia Hasta" Value="@benefit.ValidityPeriod.EndDate.ToString("dd/MM/yyyy")" />
                            }
                            else
                            {
                                <InfoField Label="Vigencia" Value="Permanente" />
                            }
                            <InfoField Label="Cupos Disponibles" Value="@benefit.Quotas.ToString()" />
                            <InfoField Label="Total Consumido" Value="@benefit.TotalConsumed.ToString()" />
                        </div>

                        <div class="benefit-status">
                            @if (benefit.CanBeConsumed)
                            {
                                <span class="badge badge-success">Disponible</span>
                            }
                            else if (!benefit.IsValid)
                            {
                                <span class="badge badge-warning">Expirado</span>
                            }
                            else if (!benefit.HasAvailableQuotas)
                            {
                                <span class="badge badge-danger">Sin Cupos</span>
                            }
                        </div>

                        @if (benefit.Consumptions.Any())
                        {
                            <div class="consumptions">
                                <h4>Mis Consumos</h4>
                                @foreach (var consumption in benefit.Consumptions)
                                {
                                    <div class="consumption-item">
                                        <span>Cantidad: @consumption.Amount</span>
                                        <span>Fecha: @consumption.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                        @if (consumption.Usages.Any())
                                        {
                                            <div class="usages">
                                                <small>Usos registrados: @consumption.Usages.Count</small>
                                                @foreach (var usage in consumption.Usages)
                                                {
                                                    <small>- @usage.UsageDateTime.ToString("dd/MM/yyyy HH:mm")</small>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="no-data">No has utilizado este beneficio a煤n</p>
                        }
                    </div>
                </Card>
            }
        </div>
    }

    <div class="back-action">
        <a href="/perfil" class="action-link">
            <PrimaryButton Text="Volver a Mi Perfil" />
        </a>
    </div>
</div>

@code {
    private List<BenefitResponse> benefits = new();
    private bool isLoading = true;
    private string? error = null;

    protected override async Task OnInitializedAsync()
    {
        await CargarBeneficios();
    }

    private async Task CargarBeneficios()
    {
        try
        {
            isLoading = true;
            error = null;

            Logger.LogInformation("CargarBeneficios iniciado. URI: {Uri}", Navigation.Uri);
            
            // TESTING: Modo r谩pido con query parameter ?devUserId=X
            var uri = new Uri(Navigation.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);

            Logger.LogInformation("Query params: {QueryCount}", query.Count);
            
            if (query.TryGetValue("devUserId", out var devIdValues) && int.TryParse(devIdValues.FirstOrDefault(), out var devUserId))
            {
                Logger.LogInformation("Modo dev: cargando beneficios del usuario {UserId}", devUserId);
                benefits = await BenefitApiService.GetUserBenefitsAsync(devUserId);
                Logger.LogInformation("Beneficios cargados: {Count}", benefits.Count);
                return;
            }

            Logger.LogWarning("No se encontr贸 par谩metro devUserId en la URL");
            error = "锔 Para testing, accede a /mis-beneficios?devUserId=1";

            // C贸digo original de autenticaci贸n (comentado para testing)
            /*
            // TODO: Obtener el userId desde el AuthenticationState cuando se implemente el login
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                {
                    benefits = await BenefitApiService.GetUserBenefitsAsync(userId);
                }
                else
                {
                    error = "No se pudo obtener el ID del usuario.";
                }
            }
            else
            {
                error = "Debe iniciar sesi贸n para ver sus beneficios.";
            }
            */
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar beneficios");
            error = $"Error al cargar los beneficios: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
