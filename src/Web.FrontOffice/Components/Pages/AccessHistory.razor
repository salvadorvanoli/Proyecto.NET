@page "/historial-accesos"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Web.FrontOffice.Components.Shared
@using Web.FrontOffice.Services
@using Web.FrontOffice.Services.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@inject IAccessEventApiService AccessEventApiService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ILogger<AccessHistory> Logger

<Microsoft.AspNetCore.Components.Web.PageTitle>Historial de Accesos</Microsoft.AspNetCore.Components.Web.PageTitle>

<div class="access-history-container">
    <PageHeader Title="Historial de Accesos" Subtitle="Registro completo de tus accesos al sistema" />

    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando historial...</span>
            </div>
            <p class="mt-2">Cargando historial...</p>
        </div>
    }
    else if (error != null)
    {
        <div class="alert alert-danger">
            <p>@error</p>
            @if (error.Contains("iniciar sesión"))
            {
                <hr />
                <a href="Auth/Login" class="btn btn-primary">Iniciar Sesión</a>
            }
        </div>
    }
    else if (!accessEvents.Any())
    {
        <div class="no-data alert alert-info">
            <p>No hay eventos de acceso registrados.</p>
        </div>
    }
    else
    {
        <Card>
            <div class="access-stats">
                <div class="stat-item">
                    <span class="stat-value">@totalCount</span>
                    <span class="stat-label">Total de Accesos</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">@accessEvents.Count(e => e.Result == "Granted")</span>
                    <span class="stat-label">Permitidos</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">@accessEvents.Count(e => e.Result == "Denied")</span>
                    <span class="stat-label">Denegados</span>
                </div>
            </div>
        </Card>

        <!-- Info de resultados -->
        <div class="results-info mb-3 mt-3">
            <p>Mostrando @accessEvents.Count de @totalCount eventos (Página @currentPage de @totalPages)</p>
        </div>

        <Card Title="Registro de Eventos">
            <div class="access-list">
                @foreach (var evento in accessEvents)
                {
                    <div class="access-item @(evento.Result == "Granted" ? "access-allowed" : "access-denied")">
                        <div class="access-info">
                            <div class="access-icon-wrapper">
                                <span class="access-icon">@(evento.Result == "Granted" ? "✓" : "✗")</span>
                            </div>
                            <div class="access-content">
                                <div class="access-details">
                                    <span class="access-location">@evento.ControlPoint.Name</span>
                                    <div class="access-datetime">
                                        <span class="access-date">@evento.EventDateTime.ToString("dd/MM/yyyy")</span>
                                        <span class="access-separator">•</span>
                                        <span class="access-time">@evento.EventDateTime.ToString("HH:mm:ss")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <Badge Text="@(evento.Result == "Granted" ? "PERMITIDO" : "DENEGADO")"
                               Type="@(evento.Result == "Granted" ? "success" : "danger")" />
                    </div>
                }
            </div>
        </Card>

        <!-- Controles de paginación -->
        @if (totalCount > pageSize)
        {
            <div class="pagination-controls mt-4">
                <nav aria-label="Paginación de historial">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="PrimeraPagina" disabled="@(currentPage == 1)">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </button>
                        </li>
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="PaginaAnterior" disabled="@(currentPage == 1)">
                                <span aria-hidden="true">&laquo;</span>
                            </button>
                        </li>

                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                <button class="page-link" @onclick="() => IrAPagina(pageNum)">@pageNum</button>
                            </li>
                        }

                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="PaginaSiguiente" disabled="@(currentPage == totalPages)">
                                <span aria-hidden="true">&raquo;</span>
                            </button>
                        </li>
                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="UltimaPagina" disabled="@(currentPage == totalPages)">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </button>
                        </li>
                    </ul>
                </nav>
                <div class="text-center mt-2">
                    <small class="text-muted">Página @currentPage de @totalPages</small>
                </div>
            </div>
        }
    }

    <div class="back-action">
        <a href="/perfil" class="action-link">
            <PrimaryButton Text="Volver a Mi Perfil" />
        </a>
    </div>
</div>

@code {
    private List<AccessEventResponse> accessEvents = new();
    private bool isLoading = true;
    private string? error = null;

    // Paginación
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await CargarHistorial();
    }

    private async Task CargarHistorial()
    {
        try
        {
            isLoading = true;
            error = null;

            // Obtener userId desde los claims del usuario autenticado
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out var userId))
            {
                error = "Error al obtener el ID del usuario.";
                Logger.LogError("NameIdentifier claim not found or invalid");
                return;
            }

            Logger.LogInformation("Cargando historial del usuario {UserId}, página {Page}", userId, currentPage);

            // Calcular skip
            var skip = (currentPage - 1) * pageSize;

            // Cargar historial paginado
            var result = await AccessEventApiService.GetUserAccessEventsPagedAsync(userId, skip, pageSize);

            accessEvents = result.Events;
            totalCount = result.TotalCount;

            Logger.LogInformation("Eventos de acceso cargados: {Count} de {Total}", accessEvents.Count, totalCount);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar historial");
            error = $"Error al cargar el historial: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task IrAPagina(int page)
    {
        if (page < 1 || page > totalPages || page == currentPage)
            return;

        currentPage = page;
        await CargarHistorial();
    }

    private Task PaginaAnterior() => IrAPagina(currentPage - 1);
    private Task PaginaSiguiente() => IrAPagina(currentPage + 1);
    private Task PrimeraPagina() => IrAPagina(1);
    private Task UltimaPagina() => IrAPagina(totalPages);
}
