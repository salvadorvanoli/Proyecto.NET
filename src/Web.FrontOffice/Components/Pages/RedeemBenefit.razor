@page "/canjear-beneficio"
@using Web.FrontOffice.Services.Interfaces
@inject IBenefitApiService BenefitApiService
@inject ILogger<RedeemBenefit> Logger
@rendermode InteractiveServer

<Microsoft.AspNetCore.Components.Web.PageTitle>Canjear Beneficio</Microsoft.AspNetCore.Components.Web.PageTitle>

<div class="redeem-container">
    <PageHeader Title="Canjear Beneficio" Subtitle="Confirma tu identidad para canjear tu beneficio" />

    @if (beneficioSeleccionado == null)
    {
        <!-- Selección de beneficio -->
        <Card Title="Selecciona el Beneficio a Canjear">
            @if (cargandoBeneficios)
            {
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Cargando beneficios disponibles...</p>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorCarga))
            {
                <div class="error-container">
                    <p class="error-message">@errorCarga</p>
                    <div class="form-actions">
                        <PrimaryButton Text="Reintentar" OnClick="CargarBeneficiosAsync" />
                        <a href="/mis-beneficios" class="action-link">
                            <SecondaryButton Text="Volver" />
                        </a>
                    </div>
                </div>
            }
            else if (beneficiosDisponibles.Any())
            {
                <div class="benefits-selection-grid">
                    @foreach (var beneficio in beneficiosDisponibles)
                    {
                        <div class="benefit-card @(beneficio.Id == beneficioTemporal?.Id ? "selected" : "")"
                             @onclick="() => SeleccionarBeneficio(beneficio)">
                            <div class="benefit-card-content">
                                <h4 class="benefit-name">@beneficio.Nombre</h4>
                                <p class="benefit-description">@beneficio.Descripcion</p>
                                <div class="benefit-info">
                                    <InfoField Label="Cupos Disponibles" Value="@beneficio.CuposDisponibles.ToString()" />
                                    <InfoField Label="Vigente Hasta" Value="@beneficio.VigenciaHasta.ToString("dd/MM/yyyy")" />
                                </div>
                            </div>
                            @if (beneficio.Id == beneficioTemporal?.Id)
                            {
                                <div class="selected-indicator">
                                    <span>✓</span>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="form-actions">
                    <PrimaryButton Text="Continuar" OnClick="ConfirmarSeleccion" AdditionalClass="@(beneficioTemporal == null ? "disabled" : "")" />
                    <a href="/mis-beneficios" class="action-link">
                        <SecondaryButton Text="Cancelar" />
                    </a>
                </div>
            }
            else
            {
                <div class="no-benefits">
                    <p class="no-data">No tienes beneficios disponibles para canjear en este momento.</p>
                    <div class="back-action">
                        <a href="/mis-beneficios" class="action-link">
                            <PrimaryButton Text="Ver Mis Beneficios" />
                        </a>
                    </div>
                </div>
            }
        </Card>
    }
    else if (!mostrarModalConfirmacion)
    {
        <!-- Detalles del beneficio -->
        <Card Title="Detalles del Beneficio">
            <div class="benefit-details-container">
                <div class="benefit-summary">
                    <h4>Beneficio Seleccionado</h4>
                    <div class="summary-content">
                        <InfoField Label="Nombre" Value="@beneficioSeleccionado.Nombre" />
                        <InfoField Label="Descripción" Value="@beneficioSeleccionado.Descripcion" />
                        <InfoField Label="Cupos Disponibles" Value="@beneficioSeleccionado.CuposDisponibles.ToString()" />
                    </div>
                </div>

                <div class="quantity-selector">
                    <label class="form-label">Cantidad a Canjear:</label>
                    <div class="quantity-control">
                        <button class="quantity-btn" @onclick="DecrementarCantidad" disabled="@(cantidadCanjear <= 1)">-</button>
                        <input type="number" class="quantity-input" @bind="cantidadCanjear" min="1" max="@beneficioSeleccionado.CuposDisponibles" />
                        <button class="quantity-btn" @onclick="IncrementarCantidad" disabled="@(cantidadCanjear >= beneficioSeleccionado.CuposDisponibles)">+</button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <PrimaryButton Text="Canjear Beneficio" OnClick="MostrarConfirmacion" />
                    <SecondaryButton Text="Volver" OnClick="VolverSeleccion" />
                </div>
            </div>
        </Card>
    }

    <!-- Modal de confirmación -->
    @if (mostrarModalConfirmacion && beneficioSeleccionado != null)
    {
        <div class="modal-overlay" @onclick="CerrarModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Confirmar Canje de Beneficio</h3>
                    <button class="close-btn" @onclick="CerrarModal" disabled="@procesandoCanje">&times;</button>
                </div>
                <div class="modal-body">
                    @if (procesandoCanje)
                    {
                        <div class="processing-message">
                            <div class="spinner"></div>
                            <p>Procesando canje...</p>
                        </div>
                    }
                    else
                    {
                        <p>¿Estás seguro que deseas canjear este beneficio?</p>
                        <div class="confirmation-details">
                            <InfoField Label="Beneficio" Value="@beneficioSeleccionado.Nombre" />
                            <InfoField Label="Cantidad" Value="@cantidadCanjear.ToString()" />
                            <InfoField Label="Cupos que quedarán" Value="@((beneficioSeleccionado.CuposDisponibles - cantidadCanjear).ToString())" />
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <PrimaryButton Text="Confirmar Canje" OnClick="ConfirmarCanje" AdditionalClass="@(procesandoCanje ? "disabled" : "")" />
                    <SecondaryButton Text="Cancelar" OnClick="CerrarModal" AdditionalClass="@(procesandoCanje ? "disabled" : "")" />
                </div>
            </div>
        </div>
    }
    else if (canjeExitoso.HasValue)
    {
        <!-- Resultado del canje -->
        <Card>
            <div class="result-container">
                @if (canjeExitoso.Value && resultadoCanje != null)
                {
                    <div class="success-result">
                        <div class="result-icon success">
                            <span>✓</span>
                        </div>
                        <h2>¡Canje Exitoso!</h2>
                        <p>@resultadoCanje.Message</p>
                        
                        <div class="result-details">
                            <InfoField Label="Beneficio" Value="@resultadoCanje.BenefitTypeName" />
                            <InfoField Label="Cantidad Canjeada" Value="@resultadoCanje.QuantityConsumed.ToString()" />
                            <InfoField Label="Fecha y Hora" Value="@resultadoCanje.ConsumptionDateTime.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")" />
                            <InfoField Label="Cupos Restantes" Value="@resultadoCanje.RemainingQuotas.ToString()" />
                            <InfoField Label="ID de Consumo" Value="@resultadoCanje.ConsumptionId.ToString()" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="error-result">
                        <div class="result-icon error">
                            <span>✗</span>
                        </div>
                        <h2>Canje Fallido</h2>
                        <p>@mensajeError</p>
                    </div>
                }

                <div class="form-actions">
                    <PrimaryButton Text="Canjear Otro Beneficio" OnClick="ReiniciarCanje" />
                    <a href="/mis-beneficios" class="action-link">
                        <SecondaryButton Text="Ver Mis Beneficios" />
                    </a>
                </div>
            </div>
        </Card>
    }
</div>

@code {
    private List<BeneficioDisponible> beneficiosDisponibles = new List<BeneficioDisponible>();
    private bool cargandoBeneficios = true;
    private string errorCarga = string.Empty;

    private BeneficioDisponible? beneficioTemporal;
    private BeneficioDisponible? beneficioSeleccionado;
    private bool mostrarModalConfirmacion = false;
    private bool procesandoCanje = false;
    private bool? canjeExitoso;
    private string mensajeError = string.Empty;
    private int cantidadCanjear = 1;
    private Shared.DTOs.Benefits.ConsumeBenefitResponse? resultadoCanje;

    protected override async Task OnInitializedAsync()
    {
        await CargarBeneficiosAsync();
    }

    private async Task CargarBeneficiosAsync()
    {
        try
        {
            cargandoBeneficios = true;
            errorCarga = string.Empty;

            // Obtener beneficios activos desde la API
            var beneficios = await BenefitApiService.GetActiveBenefitsAsync();
            
            beneficiosDisponibles = beneficios
                .Where(b => b.CanBeConsumed && b.BenefitType != null) // Solo beneficios que se pueden consumir y tienen tipo definido
                .Select(b => new BeneficioDisponible
                {
                    Id = b.Id,
                    Nombre = b.BenefitType.Name,
                    Descripcion = b.BenefitType.Description,
                    CuposDisponibles = b.Quotas,
                    VigenciaHasta = b.ValidityPeriod?.EndDate.ToDateTime(TimeOnly.MinValue) ?? DateTime.MaxValue
                })
                .ToList();

            Logger.LogInformation("Cargados {Count} beneficios disponibles", beneficiosDisponibles.Count);
        }
        catch (Exception ex)
        {
            errorCarga = "Error al cargar los beneficios disponibles. Por favor, intenta nuevamente.";
            Logger.LogError(ex, "Error al cargar beneficios");
        }
        finally
        {
            cargandoBeneficios = false;
        }
    }

    private void SeleccionarBeneficio(BeneficioDisponible beneficio)
    {
        beneficioTemporal = beneficio;
        cantidadCanjear = 1; // Reset cantidad al seleccionar nuevo beneficio
    }

    private void ConfirmarSeleccion()
    {
        if (beneficioTemporal != null)
        {
            beneficioSeleccionado = beneficioTemporal;
            beneficioTemporal = null;
        }
    }

    private void VolverSeleccion()
    {
        beneficioSeleccionado = null;
        mostrarModalConfirmacion = false;
        canjeExitoso = null;
        cantidadCanjear = 1;
    }

    private void MostrarConfirmacion()
    {
        mostrarModalConfirmacion = true;
    }

    private void CerrarModal()
    {
        if (!procesandoCanje)
        {
            mostrarModalConfirmacion = false;
        }
    }

    private async Task ConfirmarCanje()
    {
        if (beneficioSeleccionado == null || procesandoCanje)
            return;

        procesandoCanje = true;
        StateHasChanged();

        try
        {
            var request = new Shared.DTOs.Benefits.ConsumeBenefitRequest
            {
                BenefitId = beneficioSeleccionado.Id,
                Quantity = cantidadCanjear
            };

            resultadoCanje = await BenefitApiService.ConsumeBenefitAsync(request);
            
            // Actualizar los cupos disponibles del beneficio seleccionado
            beneficioSeleccionado.CuposDisponibles -= cantidadCanjear;
            
            mostrarModalConfirmacion = false;
            canjeExitoso = true;
            
            Logger.LogInformation("Beneficio {BenefitId} canjeado exitosamente. Cantidad: {Quantity}", 
                beneficioSeleccionado.Id, cantidadCanjear);
        }
        catch (HttpRequestException ex)
        {
            mostrarModalConfirmacion = false;
            canjeExitoso = false;
            mensajeError = "Error al comunicarse con el servidor. Por favor, intenta nuevamente.";
            Logger.LogError(ex, "Error HTTP al canjear beneficio {BenefitId}", beneficioSeleccionado.Id);
        }
        catch (Exception ex)
        {
            mostrarModalConfirmacion = false;
            canjeExitoso = false;
            mensajeError = "Ocurrió un error inesperado al canjear el beneficio. Por favor, intenta nuevamente.";
            Logger.LogError(ex, "Error inesperado al canjear beneficio {BenefitId}", beneficioSeleccionado.Id);
        }
        finally
        {
            procesandoCanje = false;
            StateHasChanged();
        }
    }

    private void IncrementarCantidad()
    {
        if (beneficioSeleccionado != null && cantidadCanjear < beneficioSeleccionado.CuposDisponibles)
        {
            cantidadCanjear++;
        }
    }

    private void DecrementarCantidad()
    {
        if (cantidadCanjear > 1)
        {
            cantidadCanjear--;
        }
    }

    private void ReiniciarCanje()
    {
        beneficioSeleccionado = null;
        beneficioTemporal = null;
        mostrarModalConfirmacion = false;
        procesandoCanje = false;
        canjeExitoso = null;
        mensajeError = string.Empty;
        cantidadCanjear = 1;
        resultadoCanje = null;
    }

    public class BeneficioDisponible
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Descripcion { get; set; } = string.Empty;
        public int CuposDisponibles { get; set; }
        public DateTime VigenciaHasta { get; set; }
    }
}
