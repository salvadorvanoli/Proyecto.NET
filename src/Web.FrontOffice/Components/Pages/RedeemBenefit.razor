@page "/canjear-beneficio"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Web.FrontOffice.Components.Shared
@using Web.FrontOffice.Services
@using Web.FrontOffice.Services.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Application.Benefits.DTOs
@inject IBenefitApiService BenefitApiService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ILogger<RedeemBenefit> Logger

<Microsoft.AspNetCore.Components.Web.PageTitle>Canjear Beneficio</Microsoft.AspNetCore.Components.Web.PageTitle>

<div class="redeem-container">
    <PageHeader Title="Canjear Beneficio" Subtitle="Selecciona y confirma el beneficio que deseas canjear" />

    @if (beneficioSeleccionado == null)
    {
        <!-- Selección de beneficio -->
        <Card Title="Selecciona el Beneficio a Canjear">
            @if (isLoading)
            {
                <div class="loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando beneficios...</span>
                    </div>
                    <p class="mt-2">Cargando beneficios...</p>
                </div>
            }
            else if (error != null)
            {
                <div class="alert alert-danger">
                    <p>@error</p>
                </div>
            }
            else if (beneficiosDisponibles.Any())
            {
                <div class="benefits-selection-grid">
                    @foreach (var beneficio in beneficiosDisponibles)
                    {
                        <div class="benefit-card @(beneficio.Id == beneficioTemporal?.Id ? "selected" : "")"
                             @onclick="() => SeleccionarBeneficio(beneficio)">
                            <div class="benefit-card-content">
                                <h4 class="benefit-name">@beneficio.BenefitType.Name</h4>
                                <p class="benefit-description">@beneficio.BenefitType.Description</p>
                                <div class="benefit-info">
                                    <InfoField Label="Cupos Disponibles" Value="@beneficio.Quotas.ToString()" />
                                    @if (beneficio.ValidityPeriod != null)
                                    {
                                        <InfoField Label="Vigente Hasta" Value="@beneficio.ValidityPeriod.EndDate.ToString("dd/MM/yyyy")" />
                                    }
                                    else
                                    {
                                        <InfoField Label="Vigencia" Value="Permanente" />
                                    }
                                </div>
                            </div>
                            @if (beneficio.Id == beneficioTemporal?.Id)
                            {
                                <div class="selected-indicator">
                                    <span>✓</span>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="form-actions">
                    <PrimaryButton Text="Continuar" OnClick="ConfirmarSeleccion" AdditionalClass="@(beneficioTemporal == null ? "disabled" : "")" />
                    <a href="/mis-beneficios" class="action-link">
                        <SecondaryButton Text="Cancelar" />
                    </a>
                </div>
            }
            else
            {
                <div class="no-benefits">
                    <p class="no-data">No tienes beneficios disponibles para canjear en este momento.</p>
                    <div class="back-action">
                        <a href="/mis-beneficios" class="action-link">
                            <PrimaryButton Text="Ver Mis Beneficios" />
                        </a>
                    </div>
                </div>
            }
        </Card>
    }
    else if (!confirmacionCanje)
    {
        <!-- Modal de Confirmación -->
        <Card Title="Confirmar Canje">
            <div class="password-container">
                <div class="benefit-summary">
                    <h4>Beneficio Seleccionado</h4>
                    <div class="summary-content">
                        <InfoField Label="Nombre" Value="@beneficioSeleccionado.BenefitType.Name" />
                        <InfoField Label="Descripción" Value="@beneficioSeleccionado.BenefitType.Description" />
                        <InfoField Label="Cantidad a Canjear" Value="@cantidadCanjear.ToString()" />
                    </div>
                </div>

                <div class="password-section">
                    @if (!procesandoCanje)
                    {
                        <div class="password-prompt">
                            <h3>Confirmar Canje</h3>
                            <p>¿Estás seguro de que deseas canjear este beneficio?</p>
                            
                            <div class="quantity-selector">
                                <label class="form-label">Cantidad a Canjear:</label>
                                <div class="quantity-control">
                                    <button class="quantity-btn" @onclick="DecrementarCantidad" disabled="@(cantidadCanjear <= 1)">-</button>
                                    <input type="number" class="quantity-input" @bind="cantidadCanjear" min="1" max="@beneficioSeleccionado.Quotas" />
                                    <button class="quantity-btn" @onclick="IncrementarCantidad" disabled="@(cantidadCanjear >= beneficioSeleccionado.Quotas)">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <PrimaryButton Text="Confirmar Canje" OnClick="ProcesarCanje" />
                            <SecondaryButton Text="Volver" OnClick="VolverSeleccion" />
                        </div>
                    }
                    else
                    {
                        <div class="processing-validation">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Procesando canje...</span>
                            </div>
                            <h3>Procesando Canje...</h3>
                            <p>Por favor, espera un momento.</p>
                        </div>
                    }
                </div>
            </div>
        </Card>
    }
    else if (canjeExitoso.HasValue)
    {
        <!-- Resultado del canje -->
        <Card>
            <div class="result-container">
                @if (canjeExitoso.Value)
                {
                    <div class="success-result">
                        <div class="result-icon success">
                            <span>✓</span>
                        </div>
                        <h2>¡Canje Exitoso!</h2>
                        <p>Tu beneficio ha sido canjeado correctamente.</p>
                        
                        <div class="result-details">
                            <InfoField Label="Beneficio" Value="@beneficioSeleccionado.BenefitType.Name" />
                            <InfoField Label="Cantidad Canjeada" Value="@cantidadCanjeada.ToString()" />
                            <InfoField Label="Fecha y Hora" Value="@fechaCanje?.ToString("dd/MM/yyyy HH:mm:ss")" />
                            <InfoField Label="Cupos Restantes" Value="@cuposRestantes.ToString()" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="error-result">
                        <div class="result-icon error">
                            <span>✗</span>
                        </div>
                        <h2>Canje Fallido</h2>
                        <p>@mensajeError</p>
                    </div>
                }

                <div class="form-actions">
                    <PrimaryButton Text="Canjear Otro Beneficio" OnClick="ReiniciarCanje" />
                    <a href="/mis-beneficios" class="action-link">
                        <SecondaryButton Text="Ver Mis Beneficios" />
                    </a>
                </div>
            </div>
        </Card>
    }
</div>

@code {
    private List<Application.Benefits.DTOs.BenefitResponse> beneficiosDisponibles = new();
    private Application.Benefits.DTOs.BenefitResponse? beneficioTemporal;
    private Application.Benefits.DTOs.BenefitResponse? beneficioSeleccionado;
    private bool isLoading = true;
    private string? error = null;
    private bool confirmacionCanje = false;
    private bool procesandoCanje = false;
    private bool? canjeExitoso;
    private string mensajeError = string.Empty;
    private int cantidadCanjear = 1;
    private int cantidadCanjeada = 0;
    private int cuposRestantes = 0;
    private DateTime? fechaCanje;
    private int currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await CargarBeneficios();
    }

    private async Task CargarBeneficios()
    {
        try
        {
            isLoading = true;
            error = null;

            // Obtener userId desde los claims del usuario autenticado
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out currentUserId))
            {
                error = "Error al obtener el ID del usuario.";
                Logger.LogError("NameIdentifier claim not found or invalid");
                return;
            }

            Logger.LogInformation("Cargando beneficios disponibles para canjear del usuario {UserId}", currentUserId);

            // Cargar todos los beneficios del usuario
            var allBenefits = await BenefitApiService.GetUserBenefitsAsync(currentUserId);
            
            // Filtrar solo los beneficios que se pueden canjear
            beneficiosDisponibles = allBenefits
                .Where(b => b.CanBeConsumed)
                .ToList();

            Logger.LogInformation("Beneficios disponibles para canjear: {Count}", beneficiosDisponibles.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar beneficios disponibles");
            error = $"Error al cargar los beneficios: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SeleccionarBeneficio(Application.Benefits.DTOs.BenefitResponse beneficio)
    {
        beneficioTemporal = beneficio;
        cantidadCanjear = 1; // Reset cantidad al seleccionar nuevo beneficio
    }

    private void ConfirmarSeleccion()
    {
        if (beneficioTemporal != null)
        {
            beneficioSeleccionado = beneficioTemporal;
            beneficioTemporal = null;
        }
    }

    private void VolverSeleccion()
    {
        beneficioSeleccionado = null;
        confirmacionCanje = false;
        procesandoCanje = false;
        canjeExitoso = null;
        cantidadCanjear = 1;
    }

    private void IncrementarCantidad()
    {
        if (beneficioSeleccionado != null && cantidadCanjear < beneficioSeleccionado.Quotas)
        {
            cantidadCanjear++;
        }
    }

    private void DecrementarCantidad()
    {
        if (cantidadCanjear > 1)
        {
            cantidadCanjear--;
        }
    }

    private async Task ProcesarCanje()
    {
        if (beneficioSeleccionado == null)
        {
            return;
        }

        procesandoCanje = true;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Iniciando canje de beneficio {BenefitId} para usuario {UserId} con cantidad {Quantity}",
                beneficioSeleccionado.Id, currentUserId, cantidadCanjear);

            var request = new global::Shared.DTOs.Benefits.RedeemBenefitRequest
            {
                BenefitId = beneficioSeleccionado.Id,
                UserId = currentUserId,
                Quantity = cantidadCanjear
            };

            var response = await BenefitApiService.RedeemBenefitAsync(request);

            // Guardar información del canje exitoso
            cantidadCanjeada = response.QuantityRedeemed;
            cuposRestantes = response.RemainingQuotas;
            fechaCanje = response.RedeemedAt;

            canjeExitoso = true;
            confirmacionCanje = true;

            Logger.LogInformation("Canje exitoso: {Message}", response.Message);
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Error HTTP al canjear beneficio");
            canjeExitoso = false;
            confirmacionCanje = true;
            mensajeError = ex.Message.Contains("Error al canjear") 
                ? ex.Message 
                : "Error de conexión con el servidor. Por favor, intenta nuevamente.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error inesperado al canjear beneficio");
            canjeExitoso = false;
            confirmacionCanje = true;
            mensajeError = "Ocurrió un error inesperado al procesar el canje. Por favor, intenta nuevamente.";
        }
        finally
        {
            procesandoCanje = false;
            StateHasChanged();
        }
    }

    private async Task ReiniciarCanje()
    {
        beneficioSeleccionado = null;
        beneficioTemporal = null;
        confirmacionCanje = false;
        procesandoCanje = false;
        canjeExitoso = null;
        mensajeError = string.Empty;
        cantidadCanjear = 1;
        cantidadCanjeada = 0;
        cuposRestantes = 0;
        fechaCanje = null;

        // Recargar los beneficios para reflejar los cambios
        await CargarBeneficios();
    }
}
