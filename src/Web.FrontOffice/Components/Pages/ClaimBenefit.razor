@page "/reclamar-beneficio"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Web.FrontOffice.Components.Shared
@using Web.FrontOffice.Services.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using AvailableBenefitResponse = global::Shared.DTOs.Benefits.AvailableBenefitResponse
@using ClaimBenefitRequest = global::Shared.DTOs.Benefits.ClaimBenefitRequest
@inject IBenefitApiService BenefitApiService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ILogger<ClaimBenefit> Logger

<Microsoft.AspNetCore.Components.Web.PageTitle>Reclamar Beneficio</Microsoft.AspNetCore.Components.Web.PageTitle>

<div class="claim-container">
    <PageHeader Title="Reclamar Beneficio" Subtitle="@(beneficioSeleccionado == null ? "Selecciona un beneficio para reclamar" : "Confirma la reclamaciÃ³n")" />

    @if (beneficioSeleccionado == null)
    {
        <!-- SelecciÃ³n de beneficio -->
        <Card Title="Beneficios Disponibles para Reclamar">
            @if (isLoading)
            {
                <div class="loading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando beneficios...</span>
                    </div>
                    <p class="mt-2">Cargando beneficios disponibles...</p>
                </div>
            }
            else if (error != null)
            {
                <div class="alert alert-danger">
                    <p>@error</p>
                </div>
            }
            else if (beneficiosDisponibles.Any())
            {
                <!-- Info de resultados -->
                <div class="results-info mb-3">
                    <p>Mostrando @beneficiosPaginados.Count() de @beneficiosDisponibles.Count beneficios</p>
                </div>

                <div class="benefits-grid">
                    @foreach (var beneficio in beneficiosPaginados)
                    {
                        <div class="benefit-card @(beneficio.Id == beneficioTemporal?.Id ? "selected" : "")"
                             @onclick="() => SeleccionarBeneficio(beneficio)">
                            <div class="benefit-card-content">
                                <h4 class="benefit-name">@beneficio.BenefitTypeName</h4>
                                <div class="benefit-info">
                                    <InfoField Label="Cupos Disponibles" Value="@beneficio.Quotas.ToString()" />
                                    @if (!beneficio.IsPermanent)
                                    {
                                        <InfoField Label="VÃ¡lido Desde" Value="@beneficio.StartDate" />
                                        <InfoField Label="VÃ¡lido Hasta" Value="@beneficio.EndDate" />
                                    }
                                    else
                                    {
                                        <InfoField Label="Vigencia" Value="Permanente" />
                                    }
                                </div>
                            </div>
                            @if (beneficio.Id == beneficioTemporal?.Id)
                            {
                                <div class="selected-indicator">
                                    <span>âœ“</span>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Controles de paginaciÃ³n -->
                @if (beneficiosDisponibles.Count > pageSize)
                {
                    <div class="pagination-controls mt-4">
                        <nav aria-label="PaginaciÃ³n de beneficios">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PrimeraPagina" disabled="@(currentPage == 1)">
                                        <span aria-hidden="true">&laquo;&laquo;</span>
                                    </button>
                                </li>
                                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                    <button class="page-link" @onclick="PaginaAnterior" disabled="@(currentPage == 1)">
                                        <span aria-hidden="true">&laquo;</span>
                                    </button>
                                </li>
                                
                                @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                {
                                    var pageNum = i;
                                    <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                        <button class="page-link" @onclick="() => IrAPagina(pageNum)">@pageNum</button>
                                    </li>
                                }

                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="PaginaSiguiente" disabled="@(currentPage == totalPages)">
                                        <span aria-hidden="true">&raquo;</span>
                                    </button>
                                </li>
                                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                    <button class="page-link" @onclick="UltimaPagina" disabled="@(currentPage == totalPages)">
                                        <span aria-hidden="true">&raquo;&raquo;</span>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }

                <div class="form-actions">
                    <PrimaryButton Text="Continuar" OnClick="ConfirmarSeleccion" AdditionalClass="@(beneficioTemporal == null ? "disabled" : "")" />
                    <a href="/" class="action-link">
                        <SecondaryButton Text="Cancelar" />
                    </a>
                </div>
            }
            else
            {
                <div class="no-benefits">
                    <p class="no-data">No hay beneficios disponibles para reclamar en este momento.</p>
                    <div class="back-action">
                        <a href="/" class="action-link">
                            <PrimaryButton Text="Volver" />
                        </a>
                    </div>
                </div>
            }
        </Card>
    }
    else if (!confirmacionReclamacion)
    {
        <!-- Modal de ConfirmaciÃ³n -->
        <Card Title="Confirmar ReclamaciÃ³n">
            <div class="password-container">
                <div class="benefit-summary">
                    <h4>Beneficio Seleccionado</h4>
                    <div class="summary-content">
                        <InfoField Label="Nombre" Value="@beneficioSeleccionado.BenefitTypeName" />
                        <InfoField Label="Cupos Disponibles" Value="@beneficioSeleccionado.Quotas.ToString()" />
                        @if (!beneficioSeleccionado.IsPermanent)
                        {
                            <InfoField Label="Vigencia" Value="@($"{beneficioSeleccionado.StartDate} - {beneficioSeleccionado.EndDate}")" />
                        }
                        else
                        {
                            <InfoField Label="Vigencia" Value="Permanente" />
                        }
                    </div>
                </div>

                <div class="password-section">
                    @if (!procesandoReclamacion)
                    {
                        <div class="password-prompt">
                            <h3>Confirmar ReclamaciÃ³n</h3>
                            <p>Â¿EstÃ¡s seguro de que deseas reclamar este beneficio?</p>
                            <p class="text-muted">Al reclamar, el beneficio quedarÃ¡ disponible para canjear.</p>
                        </div>
                        
                        <div class="form-actions">
                            <PrimaryButton Text="Confirmar ReclamaciÃ³n" OnClick="ProcesarReclamacion" />
                            <SecondaryButton Text="Volver" OnClick="VolverSeleccion" />
                        </div>
                    }
                    else
                    {
                        <div class="processing-validation">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Procesando reclamaciÃ³n...</span>
                            </div>
                            <h3>Procesando ReclamaciÃ³n...</h3>
                            <p>Por favor, espera un momento.</p>
                        </div>
                    }
                </div>
            </div>
        </Card>
    }
    else if (reclamacionExitosa.HasValue)
    {
        <!-- Resultado de la reclamaciÃ³n -->
        <Card>
            <div class="result-container">
                @if (reclamacionExitosa.Value)
                {
                    <div class="success-result">
                        <div class="result-icon success">
                            <span>âœ“</span>
                        </div>
                        <h2>Â¡ReclamaciÃ³n Exitosa!</h2>
                        <p>@mensajeExito</p>
                        
                        <div class="result-details">
                            <InfoField Label="Beneficio" Value="@beneficioSeleccionado.BenefitTypeName" />
                            <InfoField Label="Consumiciones Recibidas" Value="@usageQuantity.ToString()" />
                            <InfoField Label="Cupos Restantes del Beneficio" Value="@remainingQuotas.ToString()" />
                            <InfoField Label="Fecha y Hora" Value="@fechaReclamacion?.ToString("dd/MM/yyyy HH:mm:ss")" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="error-result">
                        <div class="result-icon error">
                            <span>âœ—</span>
                        </div>
                        <h2>ReclamaciÃ³n Fallida</h2>
                        <p>@mensajeError</p>
                    </div>
                }

                <div class="form-actions">
                    <PrimaryButton Text="Reclamar Otro Beneficio" OnClick="ReiniciarReclamacion" />
                    <a href="/" class="action-link">
                        <SecondaryButton Text="Volver al Inicio" />
                    </a>
                </div>
            </div>
        </Card>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public int? BenefitId { get; set; }

    private List<AvailableBenefitResponse> beneficiosDisponibles = new();
    private AvailableBenefitResponse? beneficioTemporal;
    private AvailableBenefitResponse? beneficioSeleccionado;
    private bool isLoading = true;
    private string? error = null;
    private bool confirmacionReclamacion = false;
    private bool procesandoReclamacion = false;
    private bool? reclamacionExitosa;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private int usageQuantity = 0;
    private int remainingQuotas = 0;
    private DateTime? fechaReclamacion;
    private int currentUserId;

    // PaginaciÃ³n
    private int currentPage = 1;
    private int pageSize = 6;
    private int totalPages => (int)Math.Ceiling((double)beneficiosDisponibles.Count / pageSize);
    private IEnumerable<AvailableBenefitResponse> beneficiosPaginados =>
        beneficiosDisponibles.Skip((currentPage - 1) * pageSize).Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        await CargarBeneficiosDisponibles();
    }

    private async Task CargarBeneficiosDisponibles()
    {
        try
        {
            isLoading = true;
            error = null;

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out currentUserId))
            {
                error = "Error al obtener el ID del usuario.";
                Logger.LogError("NameIdentifier claim not found or invalid");
                return;
            }

            Logger.LogInformation("ðŸ” [CLAIM] Cargando beneficios disponibles para reclamar del usuario {UserId}", currentUserId);

            beneficiosDisponibles = await BenefitApiService.GetAvailableBenefitsAsync(currentUserId);

            Logger.LogInformation("ðŸ“‹ [CLAIM] Beneficios disponibles cargados: {Count}. IDs: [{BenefitIds}]", 
                beneficiosDisponibles.Count,
                string.Join(", ", beneficiosDisponibles.Select(b => $"{b.Id}:{b.BenefitTypeName}")));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar beneficios disponibles para reclamar");
            error = $"Error al cargar los beneficios: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SeleccionarBeneficio(AvailableBenefitResponse beneficio)
    {
        beneficioTemporal = beneficio;
    }

    private void ConfirmarSeleccion()
    {
        if (beneficioTemporal != null)
        {
            beneficioSeleccionado = beneficioTemporal;
            beneficioTemporal = null;
            StateHasChanged();
        }
    }

    private void VolverSeleccion()
    {
        beneficioSeleccionado = null;
        confirmacionReclamacion = false;
        procesandoReclamacion = false;
        reclamacionExitosa = null;
    }

    private async Task ProcesarReclamacion()
    {
        if (beneficioSeleccionado == null)
        {
            return;
        }

        procesandoReclamacion = true;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Iniciando reclamaciÃ³n de beneficio {BenefitId} para usuario {UserId}",
                beneficioSeleccionado.Id, currentUserId);

            var request = new ClaimBenefitRequest
            {
                BenefitId = beneficioSeleccionado.Id,
                UserId = currentUserId
            };

            var response = await BenefitApiService.ClaimBenefitAsync(request);

            // Guardar informaciÃ³n de la reclamaciÃ³n exitosa
            mensajeExito = response.Message;
            usageQuantity = response.UsageQuantity;
            remainingQuotas = response.RemainingBenefitQuotas;
            fechaReclamacion = response.ClaimedAt;

            reclamacionExitosa = true;
            confirmacionReclamacion = true;

            Logger.LogInformation("ReclamaciÃ³n exitosa: {Message}", response.Message);
        }
        catch (HttpRequestException ex)
        {
            Logger.LogError(ex, "Error HTTP al reclamar beneficio");
            reclamacionExitosa = false;
            confirmacionReclamacion = true;
            mensajeError = ex.Message.Contains("Error al reclamar") 
                ? ex.Message 
                : "Error de conexiÃ³n con el servidor. Por favor, intenta nuevamente.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error inesperado al reclamar beneficio");
            reclamacionExitosa = false;
            confirmacionReclamacion = true;
            mensajeError = "OcurriÃ³ un error inesperado al procesar la reclamaciÃ³n. Por favor, intenta nuevamente.";
        }
        finally
        {
            procesandoReclamacion = false;
            StateHasChanged();
        }
    }

    private async Task ReiniciarReclamacion()
    {
        beneficioSeleccionado = null;
        beneficioTemporal = null;
        confirmacionReclamacion = false;
        procesandoReclamacion = false;
        reclamacionExitosa = null;
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
        usageQuantity = 0;
        remainingQuotas = 0;
        fechaReclamacion = null;

        // Recargar los beneficios para reflejar los cambios
        await CargarBeneficiosDisponibles();
    }

    // MÃ©todos de paginaciÃ³n
    private void PrimeraPagina() => currentPage = 1;
    private void UltimaPagina() => currentPage = totalPages;
    private void PaginaAnterior() { if (currentPage > 1) currentPage--; }
    private void PaginaSiguiente() { if (currentPage < totalPages) currentPage++; }
    private void IrAPagina(int page) => currentPage = page;
}
