@page "/acceso-nfc"
@using Web.FrontOffice.Components.Shared
@rendermode InteractiveServer

<Microsoft.AspNetCore.Components.Web.PageTitle>Acceso NFC</Microsoft.AspNetCore.Components.Web.PageTitle>

<div class="access-container">
    <PageHeader Title="Control de Acceso" Subtitle="Valida tu credencial NFC para ingresar" />

    @if (!validacionIniciada)
    {
        <!-- Estado inicial - Esperando validación -->
        <Card>
            <div class="nfc-ready-state">
                <div class="nfc-icon-container">
                    <div class="nfc-waves">
                        <div class="wave wave-1"></div>
                        <div class="wave wave-2"></div>
                        <div class="wave wave-3"></div>
                    </div>
                    <div class="nfc-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 8.32a3.84 3.84 0 0 1 0 7.36M9.5 7a7.86 7.86 0 0 1 0 10M13 5.68a11.88 11.88 0 0 1 0 12.64"></path>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>
                    </div>
                </div>
                
                <h2>Listo para Escanear</h2>
                <p class="instruction-text">Acerca tu credencial o dispositivo al lector NFC. El sistema detectará automáticamente el punto de acceso y validará tus permisos.</p>


                <div class="form-actions">
                    <PrimaryButton Text="Iniciar Validación NFC" OnClick="IniciarValidacionNFC" />
                </div>
            </div>
        </Card>
    }
    else if (procesandoValidacion)
    {
        <!-- Procesando validación NFC -->
        <Card>
            <div class="nfc-processing-state">
                <div class="nfc-scanning">
                    <div class="scan-circle"></div>
                    <div class="nfc-icon-small">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 8.32a3.84 3.84 0 0 1 0 7.36M9.5 7a7.86 7.86 0 0 1 0 10M13 5.68a11.88 11.88 0 0 1 0 12.64"></path>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>
                    </div>
                </div>
                
                <h2>Validando Credencial...</h2>
                <p class="instruction-text">Mantén tu credencial cerca del lector hasta que se complete la validación.</p>
                
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>

                <div class="validation-info">
                    <InfoField Label="Punto de Acceso Detectado" Value="@puntoAccesoDetectado" />
                    <InfoField Label="Estado" Value="Procesando..." />
                </div>
            </div>
        </Card>
    }
    else if (resultadoAcceso != null)
    {
        <!-- Resultado de la validación -->
        <Card>
            <div class="access-result-container">
                @if (resultadoAcceso.Permitido)
                {
                    <div class="access-granted">
                        <div class="result-icon success">
                            <span>✓</span>
                        </div>
                        <h2>Acceso Permitido</h2>
                        <p class="result-message">Bienvenido/a. Puedes ingresar.</p>
                        
                        <div class="access-details">
                            <InfoField Label="Usuario" Value="@resultadoAcceso.NombreUsuario" />
                            <InfoField Label="Punto de Acceso" Value="@resultadoAcceso.PuntoAcceso" />
                            <InfoField Label="Fecha y Hora" Value="@resultadoAcceso.FechaHora.ToString("dd/MM/yyyy HH:mm:ss")" />
                            <InfoField Label="Credencial" Value="@resultadoAcceso.NumeroCredencial" />
                        </div>

                        @if (resultadoAcceso.Roles.Any())
                        {
                            <div class="user-roles">
                                <span class="roles-label">Roles Activos:</span>
                                <div class="roles-list">
                                    @foreach (var rol in resultadoAcceso.Roles)
                                    {
                                        <Badge Text="@rol" Type="success" />
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="access-denied">
                        <div class="result-icon error">
                            <span>✗</span>
                        </div>
                        <h2>Acceso Denegado</h2>
                        <p class="result-message">@resultadoAcceso.MensajeError</p>
                        
                        <div class="access-details">
                            <InfoField Label="Punto de Acceso" Value="@resultadoAcceso.PuntoAcceso" />
                            <InfoField Label="Fecha y Hora" Value="@resultadoAcceso.FechaHora.ToString("dd/MM/yyyy HH:mm:ss")" />
                            <InfoField Label="Razón" Value="@resultadoAcceso.RazonDenegacion" />
                        </div>

                        <div class="help-section">
                            <p class="help-text">Si crees que esto es un error, contacta al administrador del sistema.</p>
                        </div>
                    </div>
                }

                <div class="form-actions">
                    <PrimaryButton Text="Nueva Validación" OnClick="NuevaValidacion" />
                    <a href="/historial-accesos" class="action-link">
                        <SecondaryButton Text="Ver Historial" />
                    </a>
                </div>
            </div>
        </Card>
    }

    <!-- Historial reciente (siempre visible) -->
    <div class="recent-history">
        <SectionTitle Title="Intentos Recientes" />
        <Card>
            @if (historialReciente.Any())
            {
                <div class="history-list">
                    @foreach (var evento in historialReciente.Take(5))
                    {
                        <div class="history-item @(evento.Permitido ? "access-allowed" : "access-denied")">
                            <div class="history-info">
                                <div class="history-icon">
                                    <span>@(evento.Permitido ? "✓" : "✗")</span>
                                </div>
                                <div class="history-content">
                                    <span class="history-location">@evento.PuntoAcceso</span>
                                    <span class="history-datetime">@evento.FechaHora.ToString("dd/MM/yyyy HH:mm")</span>
                                </div>
                            </div>
                            <Badge Text="@(evento.Permitido ? "PERMITIDO" : "DENEGADO")"
                                   Type="@(evento.Permitido ? "success" : "danger")" />
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="no-data">No hay registros de acceso recientes.</p>
            }
        </Card>
    </div>
</div>

@code {
    private List<string> puntosAccesoPosibles = new List<string>
    {
        "Entrada Principal",
        "Salida Principal",
        "Estacionamiento",
        "Área Restringida",
        "Laboratorio A",
        "Sala de Servidores"
    };

    private string puntoAccesoDetectado = string.Empty;
    private bool validacionIniciada = false;
    private bool procesandoValidacion = false;
    private ResultadoAcceso? resultadoAcceso;

    private List<EventoAcceso> historialReciente = new List<EventoAcceso>
    {
        new EventoAcceso
        {
            PuntoAcceso = "Entrada Principal",
            FechaHora = DateTime.Now.AddHours(-2),
            Permitido = true
        },
        new EventoAcceso
        {
            PuntoAcceso = "Salida Principal",
            FechaHora = DateTime.Now.AddHours(-8),
            Permitido = true
        },
        new EventoAcceso
        {
            PuntoAcceso = "Área Restringida",
            FechaHora = DateTime.Now.AddDays(-1),
            Permitido = false
        }
    };

    private async Task IniciarValidacionNFC()
    {
        validacionIniciada = true;
        procesandoValidacion = true;
        
        // Simular detección automática del punto de acceso
        var random = new Random();
        puntoAccesoDetectado = puntosAccesoPosibles[random.Next(puntosAccesoPosibles.Count)];
        
        StateHasChanged();

        // Simular proceso de validación NFC
        await Task.Delay(2500);

        // Simular resultado (85% de éxito)
        var exitoso = random.Next(100) < 85;

        procesandoValidacion = false;

        if (exitoso)
        {
            resultadoAcceso = new ResultadoAcceso
            {
                Permitido = true,
                NombreUsuario = "Juan Pérez",
                PuntoAcceso = puntoAccesoDetectado,
                FechaHora = DateTime.Now,
                NumeroCredencial = "CRED-2024-001",
                Roles = new List<string> { "Profesor", "Director" }
            };

            // Agregar al historial
            historialReciente.Insert(0, new EventoAcceso
            {
                PuntoAcceso = resultadoAcceso.PuntoAcceso,
                FechaHora = resultadoAcceso.FechaHora,
                Permitido = true
            });
        }
        else
        {
            // Simular diferentes razones de denegación
            var razones = new[]
            {
                ("Credencial Inactiva", "Tu credencial ha sido desactivada temporalmente"),
                ("Fuera de Horario", "No tienes permisos para acceder en este horario"),
                ("Área Restringida", "No tienes autorización para acceder a esta área"),
                ("Credencial Vencida", "Tu credencial ha expirado")
            };

            var razonSeleccionada = razones[random.Next(razones.Length)];

            resultadoAcceso = new ResultadoAcceso
            {
                Permitido = false,
                PuntoAcceso = puntoAccesoDetectado,
                FechaHora = DateTime.Now,
                RazonDenegacion = razonSeleccionada.Item1,
                MensajeError = razonSeleccionada.Item2
            };

            // Agregar al historial
            historialReciente.Insert(0, new EventoAcceso
            {
                PuntoAcceso = resultadoAcceso.PuntoAcceso,
                FechaHora = resultadoAcceso.FechaHora,
                Permitido = false
            });
        }

        StateHasChanged();
    }

    private void NuevaValidacion()
    {
        validacionIniciada = false;
        procesandoValidacion = false;
        resultadoAcceso = null;
        puntoAccesoDetectado = string.Empty;
    }

    public class ResultadoAcceso
    {
        public bool Permitido { get; set; }
        public string NombreUsuario { get; set; } = string.Empty;
        public string PuntoAcceso { get; set; } = string.Empty;
        public DateTime FechaHora { get; set; }
        public string NumeroCredencial { get; set; } = string.Empty;
        public List<string> Roles { get; set; } = new();
        public string RazonDenegacion { get; set; } = string.Empty;
        public string MensajeError { get; set; } = string.Empty;
    }

    public class EventoAcceso
    {
        public string PuntoAcceso { get; set; } = string.Empty;
        public DateTime FechaHora { get; set; }
        public bool Permitido { get; set; }
    }
}
