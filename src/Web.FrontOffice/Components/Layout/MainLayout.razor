@inherits LayoutComponentBase
@using Web.FrontOffice.Components.Shared
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Web.FrontOffice.Services
@using System.Text.Json
@inject ProtectedLocalStorage ProtectedLocalStore
@inject TenantThemeService ThemeService

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <Header />

        <article class="content px-4">
            @Body
        </article>

        <footer class="footer" style="background-color: @primaryColor">
            <div class="footer-content">
                <div class="footer-section">
                    <h5>Portal de Acceso</h5>
                    <p>Sistema integrado de gestión de accesos y beneficios</p>
                </div>
                <div class="footer-section">
                    <h6>Enlaces rápidos</h6>
                    <ul class="footer-links">
                        <li><a href="/access-nfc">Acceso NFC</a></li>
                        <li><a href="/benefits">Beneficios</a></li>
                        <li><a href="/profile">Mi Perfil</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h6>Soporte</h6>
                    <ul class="footer-links">
                        <li><a href="#">Ayuda</a></li>
                        <li><a href="#">Contacto</a></li>
                        <li><a href="#">Términos de uso</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <p class="footer-copyright">© 2025 Portal de Acceso. Todos los derechos reservados.</p>
                </div>
            </div>
        </footer>
    </main>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private string primaryColor = "#0A3D62";
    private string secondaryColor = "#1976D2";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadTenantTheme();
            StateHasChanged();
        }
    }

    private async Task LoadTenantTheme()
    {
        try
        {
            var result = await ProtectedLocalStore.GetAsync<string>("userSession");
            if (result.Success && !string.IsNullOrEmpty(result.Value))
            {
                var userSession = JsonSerializer.Deserialize<UserSession>(result.Value);
                if (userSession != null)
                {
                    await ThemeService.LoadThemeAsync(userSession.TenantId);
                    primaryColor = ThemeService.GetPrimaryColor();
                    secondaryColor = ThemeService.GetSecondaryColor();
                }
            }
        }
        catch
        {
            // Usar colores por defecto
        }
    }

    private class UserSession
    {
        public int UserId { get; set; }
        public string Email { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public int TenantId { get; set; }
    }
}
